<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US Race Demographics Explorer</title>
  <!-- D3 / TopoJSON / SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3" defer></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js" defer></script>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f7fa;color:#333}
    #loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
    #loginBox{background:#fff;padding:2rem 3rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.4);width:320px}
    #loginBox h2{margin-top:0;text-align:center}
    #loginBox input[type=password]{width:100%;padding:.75rem;font-size:1rem;border:1px solid #ccc;border-radius:8px;margin:1rem 0}
    #loginBox button{width:100%;padding:.75rem;font-size:1rem;border:none;border-radius:8px;background:#0066cc;color:#fff;cursor:pointer}
    #map{position:relative;width:100%;height:80vh;cursor:default}
    svg{width:100%;height:100%}
    .state{fill:#cfd8e3;stroke:#fff;stroke-width:1;transition:fill .15s}
    .state:hover{fill:#99b2cc;cursor:pointer}
    #tooltip{position:absolute;pointer-events:none;background:#ffffff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.25);padding:1rem 1.25rem;font-size:.9rem;line-height:1.4;min-width:240px;max-width:280px;display:none;z-index:10}
    #tooltip h3{margin:0 0 .25rem;font-size:1rem}
    #tooltip h4{margin:.5rem 0 .25rem;font-size:.85rem;color:#0066cc}
    .raceBar{display:flex;height:8px;border-radius:4px;overflow:hidden;margin:.25rem 0 .5rem}
    .raceBar div{height:100%}
  </style>
</head>
<body>
  <!-- Password Gate -->
  <div id="loginOverlay"><div id="loginBox"><h2>Please enter password</h2><input type="password" id="passwordInput" placeholder="Password" /><button id="loginBtn">Enter</button><p id="loginError" style="color:red;display:none;text-align:center">Incorrect password</p></div></div>
  <!-- Map & Tooltip -->
  <div id="map"></div>
  <div id="tooltip"></div>

<script defer>
(function(){
  const HASHED="d3ad9315b7be5dd53b31a273b3b3aba5defe700808305aa16a3062b76658a791"; // sha256("demo123")
  async function verify(pass){const enc=new TextEncoder().encode(pass);const hash=await crypto.subtle.digest("SHA-256",enc);return[...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("")===HASHED;}
  const loginBtn=document.getElementById('loginBtn');
  loginBtn.addEventListener('click',async()=>{const pass=document.getElementById('passwordInput').value;if(await verify(pass)){document.getElementById('loginOverlay').style.display='none';initApp();}else{document.getElementById('loginError').style.display='block';}});
  document.getElementById('passwordInput').addEventListener('keyup',e=>{if(e.key==='Enter')loginBtn.click();});

  function initApp(){
    if(typeof XLSX==='undefined'){showFatal('SheetJS failed to load â€“ check CDN.');return;}
    Promise.all([
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json'),
      fetch('us_state_race_sample.xlsx').then(r=>{if(!r.ok)throw new Error('Excel file not found next to HTML');return r.arrayBuffer();})
    ])
    .then(([us,buf])=>{
      const wb=XLSX.read(buf,{type:'array'});const sheet=wb.Sheets[wb.SheetNames[0]];const data=XLSX.utils.sheet_to_json(sheet);
      const stateData=d3.group(data,d=>d.State);
      drawMap(us,stateData);
    })
    .catch(err=>showFatal(err.message));
  }

  function drawMap(us,stateData){
    const mapEl=document.getElementById('map');
    const svg=d3.select(mapEl).append('svg');
    const width=mapEl.clientWidth;const height=mapEl.clientHeight;
    svg.attr('viewBox',`0 0 ${width} ${height}`);
    const projection=d3.geoAlbersUsa().translate([width/2,height/2]).scale(width*1.25);
    const path=d3.geoPath(projection);
    const states=topojson.feature(us,us.objects.states).features;

    const tooltip=document.getElementById('tooltip');

    function hideTooltip(){tooltip.style.display='none';}
    svg.on('click',hideTooltip);

    svg.selectAll('path').data(states).enter().append('path')
      .attr('class','state')
      .attr('d',path)
      .on('click',(event,d)=>{
        event.stopPropagation(); // keep map click from hiding tooltip instantly
        const rows=stateData.get(d.properties.name)||[];
        if(!rows.length){tooltip.innerHTML=`<h3>${d.properties.name}</h3><p>No data available.</p>`;}
        else{
          let html=`<h3>${d.properties.name}</h3>`;
          rows.forEach(r=>{
            html+=`<h4>${r.Year}</h4><strong>Total:</strong> ${Number(r.TotalPopulation).toLocaleString()}<div class=raceBar><div style=\"width:${r['White%']}%;background:#dfe6f9\"></div><div style=\"width:${r['Black%']}%;background:#a6bce5\"></div><div style=\"width:${r['Asian%']}%;background:#5f8dd3\"></div><div style=\"width:${r['Native%']}%;background:#2d5dbb\"></div><div style=\"width:${r['Hispanic%']}%;background:#173d99\"></div></div><small style=\"font-size:.75rem\">W B A N H&nbsp;&nbsp;</small><br><strong>Culture:</strong> ${r.CulturalAffinities}`;});
          tooltip.innerHTML=html;
        }
        const [mx,my]=d3.pointer(event,mapEl);
        const tWidth=tooltip.offsetWidth||280;
        const tHeight=tooltip.offsetHeight||200;
        let left=mx+15;let top=my-tHeight/2;
        if(left+tWidth>mapEl.clientWidth)left=mx-tWidth-15; if(top<0)top=5; if(top+tHeight>mapEl.clientHeight)top=mapEl.clientHeight-tHeight-5;
        tooltip.style.left=`${left}px`; tooltip.style.top=`${top}px`; tooltip.style.display='block';
      });
  }

  function showFatal(msg){const map=document.getElementById('map');map.innerHTML=`<p style=\"color:red;padding:2rem;text-align:center\">${msg}</p>`;}
})();
</script>
</body>
</html>